OCP Machines	Hostname						IP Address	Subnet Mask	Gateway	DNS Server		NTP Server	
Master1	VM-DC-MASTER01.dc-ocp-prod.nor.tpb.com	10.210.12.213	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35
Master2	VM-DC-MASTER02.dc-ocp-prod.nor.tpb.com	10.210.12.214	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35
Master3	VM-DC-MASTER03.dc-ocp-prod.nor.tpb.com	10.210.12.215	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35
Worker1	VM-DC-WORKER01.dc-ocp-prod.nor.tpb.com	10.210.12.216	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35
Worker2	VM-DC-WORKER02.dc-ocp-prod.nor.tpb.com	10.210.12.217	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35
Worker3	VM-DC-WORKER03.dc-ocp-prod.nor.tpb.com	10.210.12.218	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35
Worker4	VM-DC-WORKER04.dc-ocp-prod.nor.tpb.com	10.210.12.211	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35	
Bootstrap	VM-DC-BOOTSTRAP.dc-ocp-prod.nor.tpb.com	10.210.12.212	24	10.210.12.1	10.1.12.23 /24	10.1.9.34 /35



###############################################################################################
B-2. Create install-config.yaml

pullSecret: '{"auths":{"bastion.lab.local:5000": {"auth": "YWRtaW46cGFzc3cwcmQ=","email": "trungtv@vn.ibm.com"}}}'



# ssh-keygen -t rsa -b 4096 -N '' -f ~/.ssh/id_rsa
# cat /root/.ssh/id_rsa.pub > /ocp4_downloads/ocp4_install/ssh-key.txt


# awk 'NR>2 { sub(/\r/, ""); printf "%s",last} { last=$0 }' $REGISTRY_DIR/certs/registry.crt
MIIFMzCCAxugAwIBAgIULZ1iA1Ng9MBXgBnSOV4AUG9V+DEwDQYJKoZIhvcNAQELBQAwKTELMAkGA1UEBhMCVk4xGjAYBgNVBAMMEWJhc3Rpb24ubGFiLmxvY2FsMB4XDTIxMDkwMzAzMDIyOFoXDTMxMDkwMTAzMDIyOFowKTELMAkGA1UEBhMCVk4xGjAYBgNVBAMMEWJhc3Rpb24ubGFiLmxvY2FsMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA0eYyweJYW3nALzDzrJuKF9K5Gz81cHWRCiaGjdNEY5AWV2bzovWyBbdds/1PpmtudyfDfVLJZvh+uyLK8+05uNCAeKasdfdTVVNVUNaYKgGt2i5IMfzCnnLzlie0T9fLlk/h13EMI6UJNCvSr99DojW/pRccQjnhvLzlRlIZ8nVsuzjnjc3a/RuFvIjCyYFOPQ5HlN6FUOKC+Je5ku/9lK1oQlRA3D6/R0RBhsZOiw3ZzPLFWPaqa5BLTY/9/fs8uUYgQhmFLqdvNjZ3wemERCUZlPNdE4r6+iDbzw648UfRUrEps32oZJdMMgrtE/1R2Y55PA9+rxyBZdS43PQMFrtLtgVNYgghsf6musvneTMRM+JI2O+tEgTRB1AkPZVd4Fld7mm+cN9vg6UqimtK+4f4OGhQzzVuo26o1FOE/LVSDEjkh/sxk1oCSyMsK4kK2GwfhJoGpBM53X/UbIZTFID9JAciAJr3eZHLzfCP72z8uKjF/diA9FNCfDNyEtDBtVuWj7nkktfWvK8JX150X1XJeh8KxbnBaJo75DN++dKAqcMYJJt+LnEZvqgeWEb6orRn+srMUsD7H/aeNbfH4zApZdlXk+M+a+yMEemZWr9pIWH2Qr8AUA9QwY0v8abhZvHyvTwC54UYb7M0bHoC+Tib18+a5qhDCSeL5/LVUsECAwEAAaNTMFEwHQYDVR0OBBYEFOdl/mJZvLAqb6HQ99hCvNmEmfufMB8GA1UdIwQYMBaAFOdl/mJZvLAqb6HQ99hCvNmEmfufMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggIBADFi6UD0am4U3uR5pCtt469jrG5T6tospQQ8VqjD4Rr2VUqMMlMselcvAXfvyhp6BV3b3kZ4KSXxvYxWu6k7jayNwtwp7Tp4MBeOL6BYaFRRrlYIkKCCtDdo/U+WhsteC8/EihoGoz+jT9UBKvTmA19gWI8C6TrTvMaA5F0Yq6tJ8+qclQQWia3jnWxXZQ0LbQuGcohLfbe2FT6fZLb/OXEPoz5+vvKw+dwc+HVMMRI1FIeeO4uzeyhhFCyBm+pgXNvbntSiWRQ/oa93id2YJRo9nfJLCD6zKLJD4eLDOwRZdZKWtXPUk2BGjgC7kWO5BWYDM5M/CDIkARtaqYgSsVywvYxNOA8PDnjNMSiAOePurAZL2xtuZWXlthSJ6RKJoRieCfFnqbryvg04FavxC1Gr1QOBBNAMRa6jbDNuK1S5iIJVmqeax+GRS1deqjcRu1Gip1RloAtpZusn/t4or6g52nsCKkwbkXtXYuHvRNQj3Ff4zlcKk9xL+BYmhnM2MBoAGfa+bvAdPWFURixhyacJpM5Ts6b4pcuSEEcCjY+/xXJjPRuHX/oCbfBWzX1AC/FgA3vOAvrduXMJ025oMUS9zIDq7Gb51i5cZ9/C/VijddO9EyDq5hDNG4uzpDurqBw8fBNYFxi5DOhsMHCLnY4FrxrxKZU9n3+O5Q3OTU2d



- (imageContentSources)
imageContentSources:
- mirrors:
  - bastion.lab.local:5000/ocp4/openshift4
  source: quay.io/openshift-release-dev/ocp-release
- mirrors:
  - bastion.lab.local:5000/ocp4/openshift4
  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev

$ mkdir -p /ibm/installation_directory
$ cd /ibm/installation_directory
$ vi install-config.yaml




###############################################################################################
B-3. Generate the Kubernetes manifest and Ignition config files

$ cd /ibm/installation_directory

$ cp install-config.yaml /ibm/backup/install-config.yaml.backup

******************************************************************
3-1. Generate manifests

# openshift-install create manifests --dir=./


- Modify the <installation_directory>/manifests/cluster-scheduler-02-config.yml Kubernetes manifest file to prevent Pods from being scheduled on the control plane machines
Locate the mastersSchedulable parameter and set its value to False

# vi manifests/cluster-scheduler-02-config.yml
apiVersion: config.openshift.io/v1
kind: Scheduler
metadata:
  creationTimestamp: null
  name: cluster
spec:
  mastersSchedulable: false
  policy:
    name: ""
status: {}

******************************************************************
3-2. Create chrony configuration file for OCP nodes
# ll /ibm/chrony_client
-rw-r--r--. 1 root root 693 Sep  2 18:07 99-masters-chrony-configuration.yaml
-rw-r--r--. 1 root root 693 Sep  2 18:08 99-workers-chrony-configuration.yaml



$ cat << EOF | base64
  server 10.1.9.34 iburst
  driftfile /var/lib/chrony/drift
  makestep 1.0 3
  rtcsync
  logdir /var/log/chrony
EOF


# cp /ibm/chrony_client/* /ibm/installation_directory/openshift



******************************************************************
3-3. Generate ignition files
Backup:
# cp -Rf /ibm/installation_directory/* /ibm/backup

Generate ignition files
# cd /ibm/installation_directory/
# openshift-install create ignition-configs --dir=./


[root@bastion installation_directory]# ll
total 304
drwxr-x---. 2 root root     50 Sep  3 11:17 auth
-rw-r-----. 1 root root 295422 Sep  3 11:18 bootstrap.ign
-rw-r-----. 1 root root   1716 Sep  3 11:17 master.ign
-rw-r-----. 1 root root     96 Sep  3 11:18 metadata.json
-rw-r-----. 1 root root   1716 Sep  3 11:17 worker.ign
[root@bastion installation_directory]#



##########

###########


$ mkdir /ibm/coreos_inst
$ 
$ cp /ibm/installation_directory/*.ign /ibm/coreos_inst
$ 
$ ln -s /ibm/coreos_inst /var/www/html/inst
$ chown -R apache: /var/www/html/
$ chmod -R 755 /var/www/html/
$ chown -R apache: /var/www/html/inst
$ chmod -R 755 /var/www/html/inst




CREATE VMs


~/openshift-install --dir ~/ocp-install wait-for bootstrap-complete --log-level=debug

openshift-install --dir ./ wait-for bootstrap-complete --log-level=debug


Logging in the cluster
export KUBECONFIG=/ibm/installation_directory/auth/kubeconfig
oc whoami


~/openshift-install --dir ~/ocp-install wait-for install-complete


- Approving the CSRs for your machines
https://docs.openshift.com/container-platform/4.1/installing/installing_bare_metal/installingbare-metal.html#installation-approve-csrs_installing-bare-metal
oc get csr
oc adm certificate approve <csr_name>
Approve all：
$ oc get csr -o go-template='{{range .items}}{{if not .status}}{{.metadata.name}}{{"\n"}}{{end}}{{end}}' | xargs oc adm certificate approve

$$$$ oc get csr -o go-template='{{range .items}}{{if not .status}}{{.metadata.name}}{{"\n"}}{{end}}{{end}}' | xargs --no-run-if-empty oc adm certificate approve


- Configure the Operators that are not available
watch -n5 oc get clusteroperators


#######################
Fast commands:

[root@utility ~]# oc completion bash > /etc/bash_completion.d/openshift
[root@utility ~]# openshift-install completion bash > /etc/bash_completion.d/openshift-install

[root@utility ~]# source /etc/bash_completion.d/openshift
[root@utility ~]# source /etc/bash_completion.d/openshift-install
[root@utility ~]# exit
logout
[lab@utility ~]$ source /etc/bash_completion.d/openshift
[lab@utility ~]$ source /etc/bash_completion.d/openshift-install


#########################


#############################################

1.3.15.1. Disabling the default OperatorHub sources


[root@bastion installation_directory]# oc patch OperatorHub cluster --type json -p '[{"op": "add", "path": "/spec/disableAllDefaultSources", "value": true}]'
operatorhub.config.openshift.io/cluster patched




1.3.15.2.1. Changing the image registry’s management state


[root@bastion installation_directory]# oc patch configs.imageregistry.operator.openshift.io cluster --type merge --patch '{"spec":{"managementState":"Managed"}}'
config.imageregistry.operator.openshift.io/cluster patched
[root@bastion installation_directory]#



[root@bastion imageregistry]# pwd
/ibm/installation_directory/imageregistry

# openssl req -newkey rsa:4096 -nodes -sha256 -keyout registry.key \
-x509 -days 3650 -out registry.crt \
-subj "/C=VN/ST=/L=HN/O=DEV/CN=registry.ocp4.lab.local"





































